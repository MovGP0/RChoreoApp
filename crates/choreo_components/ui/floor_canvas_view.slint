import { MaterialPalette, Vertical } from "@material";

export component FloorCanvasView inherits Rectangle {
    in property <string> choreography_name: "";
    in property <string> scene_name: "";
    in property <int> floor_front: 6;
    in property <int> floor_back: 6;
    in property <int> floor_left: 6;
    in property <int> floor_right: 6;
    in property <bool> show_grid_lines: true;
    in property <color> surface_color: MaterialPalette.surface;
    in property <color> floor_color: MaterialPalette.surface_variant;
    in property <color> grid_color: MaterialPalette.secondary;
    in property <color> floor_border_color: MaterialPalette.primary;
    in property <color> title_color: MaterialPalette.on_surface;
    in property <color> subtitle_color: MaterialPalette.on_surface_variant;
    in property <length> header_padding: 16px;
    in property <length> header_spacing: 4px;
    in property <length> grid_padding: 46px;
    in property <length> grid_line_thickness: 1px;
    in property <length> border_thickness: 2px;
    in property <length> center_line_thickness: 2px;
    in property <length> center_dot_size: 8px;

    property <int> max_horizontal_meters: floor_left > floor_right ? floor_left : floor_right;
    property <int> max_vertical_meters: floor_front > floor_back ? floor_front : floor_back;
    property <float> floor_width_meters: (floor_left + floor_right) * 1.0;
    property <float> floor_height_meters: (floor_front + floor_back) * 1.0;

    callback redraw();

    background: surface_color;

    Vertical {
        spacing: 0px;

        Rectangle {
            width: parent.width;
            background: root.surface_color;
            Vertical {
                padding: root.header_padding;
                spacing: root.header_spacing;
                Text {
                    text: root.choreography_name;
                    color: root.title_color;
                    font-size: 20px;
                    horizontal-alignment: center;
                }
                Text {
                    text: root.scene_name;
                    color: root.subtitle_color;
                    font-size: 14px;
                    horizontal-alignment: center;
                }
            }
        }

        content := Rectangle {
            vertical-stretch: 1;
            background: root.surface_color;

            property <float> content_width_px: self.width / 1px;
            property <float> content_height_px: self.height / 1px;
            property <float> padding_px: root.grid_padding / 1px;
            property <float> available_width_px: content_width_px > 2.0 * padding_px
                ? content_width_px - 2.0 * padding_px
                : 0.0;
            property <float> available_height_px: content_height_px > 2.0 * padding_px
                ? content_height_px - 2.0 * padding_px
                : 0.0;
            property <float> scale_x: root.floor_width_meters > 0.0
                ? available_width_px / root.floor_width_meters
                : 1.0;
            property <float> scale_y: root.floor_height_meters > 0.0
                ? available_height_px / root.floor_height_meters
                : 1.0;
            property <float> scale: scale_x < scale_y ? scale_x : scale_y;
            property <length> floor_width: root.floor_width_meters > 0.0
                ? root.floor_width_meters * scale * 1px
                : 0px;
            property <length> floor_height: root.floor_height_meters > 0.0
                ? root.floor_height_meters * scale * 1px
                : 0px;

            floor_rect := Rectangle {
                width: content.floor_width;
                height: content.floor_height;
                x: (parent.width - self.width) / 2;
                y: (parent.height - self.height) / 2;
                background: root.floor_color;
                border-width: root.border_thickness;
                border-color: root.floor_border_color;
            }

            grid := Rectangle {
                x: floor_rect.x;
                y: floor_rect.y;
                width: floor_rect.width;
                height: floor_rect.height;
                background: transparent;
                clip: true;
                visible: root.show_grid_lines;

                for i in root.max_horizontal_meters : Rectangle {
                    width: root.grid_line_thickness;
                    height: parent.height;
                    background: root.grid_color;
                    opacity: 0.5;
                    visible: i + 1 <= root.floor_left;
                    x: parent.width / 2 - self.width / 2 - (i + 1) * content.scale * 1px;
                    y: 0px;
                }

                for i in root.max_horizontal_meters : Rectangle {
                    width: root.grid_line_thickness;
                    height: parent.height;
                    background: root.grid_color;
                    opacity: 0.5;
                    visible: i + 1 <= root.floor_right;
                    x: parent.width / 2 - self.width / 2 + (i + 1) * content.scale * 1px;
                    y: 0px;
                }

                for i in root.max_vertical_meters : Rectangle {
                    width: parent.width;
                    height: root.grid_line_thickness;
                    background: root.grid_color;
                    opacity: 0.5;
                    visible: i + 1 <= root.floor_front;
                    x: 0px;
                    y: parent.height / 2 - self.height / 2 - (i + 1) * content.scale * 1px;
                }

                for i in root.max_vertical_meters : Rectangle {
                    width: parent.width;
                    height: root.grid_line_thickness;
                    background: root.grid_color;
                    opacity: 0.5;
                    visible: i + 1 <= root.floor_back;
                    x: 0px;
                    y: parent.height / 2 - self.height / 2 + (i + 1) * content.scale * 1px;
                }
            }

            center_layer := Rectangle {
                x: floor_rect.x;
                y: floor_rect.y;
                width: floor_rect.width;
                height: floor_rect.height;
                background: transparent;

                Rectangle {
                    width: root.center_line_thickness;
                    height: parent.height;
                    background: root.floor_border_color;
                    x: parent.width / 2 - self.width / 2;
                    y: 0px;
                }

                Rectangle {
                    width: parent.width;
                    height: root.center_line_thickness;
                    background: root.floor_border_color;
                    x: 0px;
                    y: parent.height / 2 - self.height / 2;
                }

                Rectangle {
                    width: root.center_dot_size;
                    height: root.center_dot_size;
                    border-radius: self.width / 2;
                    background: root.floor_border_color;
                    x: parent.width / 2 - self.width / 2;
                    y: parent.height / 2 - self.height / 2;
                }
            }
        }
    }
}
