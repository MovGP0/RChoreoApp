import {
    DropDownMenu,
    IconButton,
    MaterialPalette,
    MaterialText,
    MenuItem,
    Vertical
} from "@material";
import { AudioPlayerView } from "audio_player_view.slint";
import { DialogHost } from "dialog_host.slint";
import {
    AxisLabel,
    FloorCanvasView,
    FloorCurve,
    FloorPosition,
    LegendEntry,
    LineSegment
} from "floor_canvas_view.slint";
import { HamburgerToggleButton } from "hamburger_toggle_button.slint";
import { MainPageDrawerHost } from "main_page_drawer_host.slint";
import { SceneListItem } from "scenes_pane_view.slint";
import { Translations } from "translations.slint";

export component MainPage inherits Rectangle {
    property <[MenuItem]> mode_items: [
        { text: Translations.mode_view },
        { text: Translations.mode_move },
        { text: Translations.mode_rotate_around_center },
        { text: Translations.mode_rotate_around_dancer },
        { text: Translations.mode_scale },
        { text: Translations.mode_line_of_sight },
    ];
    in-out property <int> selected_mode_index: -1;
    in property <bool> is_mode_selection_enabled: true;
    in-out property <length> nav_width: 0px;
    in-out property <bool> is_nav_open: false;
    in-out property <bool> is_choreography_settings_open: false;
    in-out property <bool> is_audio_player_open: false;
    in-out property <bool> is_dialog_open: false;
    in property <string> dialog_content;
    in property <[SceneListItem]> scenes;
    in property <string> scenes_search_text;
    in property <bool> scenes_show_timestamps;
    in property <bool> scenes_can_save_choreo;
    in property <bool> scenes_can_delete_scene;
    in property <bool> scenes_can_navigate_to_settings;
    in property <bool> scenes_can_navigate_to_dancer_settings;
    in property <string> floor_choreography_name: "";
    in property <string> floor_scene_name: "";
    in property <int> floor_front: 6;
    in property <int> floor_back: 6;
    in property <int> floor_left: 6;
    in property <int> floor_right: 6;
    in property <bool> floor_show_grid_lines: true;
    in property <color> floor_color: MaterialPalette.surface_variant;
    in property <color> floor_subtitle_color: MaterialPalette.on_surface_variant;
    in property <float> floor_pan_x: 0.0;
    in property <float> floor_pan_y: 0.0;
    in property <float> floor_zoom_factor: 1.0;
    in property <float> floor_dancer_size: 1.0;
    in property <[FloorPosition]> floor_positions: [];
    in property <[FloorCurve]> floor_curves: [];
    in property <[LineSegment]> floor_dashed_curve_segments: [];
    in property <[LineSegment]> floor_selection_segments: [];
    in property <[AxisLabel]> floor_axis_labels_x: [];
    in property <[AxisLabel]> floor_axis_labels_y: [];
    in property <bool> floor_show_axis_labels: false;
    in property <[LegendEntry]> floor_legend_entries: [];
    in property <bool> floor_show_legend: false;
    in property <image> floor_svg_overlay;
    in property <bool> floor_has_svg_overlay: false;
    in property <bool> floor_show_placement_overlay: false;
    in property <int> floor_remaining_positions: 0;
    out property <float> floor_bounds_left: floor_canvas.floor_bounds_left;
    out property <float> floor_bounds_top: floor_canvas.floor_bounds_top;
    out property <float> floor_bounds_right: floor_canvas.floor_bounds_right;
    out property <float> floor_bounds_bottom: floor_canvas.floor_bounds_bottom;
    out property <float> floor_canvas_width: floor_canvas.canvas_width;
    out property <float> floor_canvas_height: floor_canvas.canvas_height;
    property <length> top_bar_height: 80px;
    property <length> audio_player_height: root.is_audio_player_open ? 80px : 0px;

    callback toggle_nav();
    callback close_nav();
    callback open_settings();
    callback close_settings();
    callback open_image();
    callback open_audio();
    callback select_mode(int);
    callback close_dialog();
    callback scenes_select_scene(int);
    callback scenes_update_search_text(string);
    callback scenes_add_scene_before();
    callback scenes_add_scene_after();
    callback scenes_delete_scene();
    callback scenes_open_choreo();
    callback scenes_save_choreo();
    callback scenes_navigate_to_settings();
    callback scenes_navigate_to_dancer_settings();
    callback floor_pointer_pressed(x: float, y: float, is_primary: bool, is_in_contact: bool);
    callback floor_pointer_moved(x: float, y: float, is_primary: bool, is_in_contact: bool);
    callback floor_pointer_released(x: float, y: float, is_primary: bool, is_in_contact: bool);
    callback floor_pointer_wheel_changed(delta: float, x: float, y: float);

    background: MaterialPalette.surface_container_low;

    DialogHost {
        width: parent.width;
        height: parent.height;
        is_open: root.is_dialog_open;
        close_on_click_away: true;
        dialog_content: root.dialog_content;
        dialog_background: MaterialPalette.surface_container_high;
        overlay_color: MaterialPalette.background_modal;
        close_requested => { root.close_dialog(); }

        Rectangle {
            width: parent.width;
            height: parent.height;
            background: transparent;

            top_bar := Rectangle {
                x: 0px;
                y: 0px;
                width: parent.width;
                height: root.top_bar_height;
                background: MaterialPalette.surface;
                z: 3;

                HorizontalLayout {
                    padding: 8px;
                    spacing: 12px;

                    HamburgerToggleButton {
                        width: 48px;
                        height: 48px;
                        checked: root.is_nav_open;
                        toggle_on_click: false;
                        tooltip: Translations.main_toggle_nav_tooltip;
                        clicked => { root.toggle_nav(); }
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                        background: transparent;
                    }

                    DropDownMenu {
                        enabled: root.is_mode_selection_enabled;
                        items: root.mode_items;
                        current_index: root.selected_mode_index;
                        height: 56px;
                        width: 180px;
                        selected(index) => { root.select_mode(index); }
                    }

                    IconButton {
                        icon: @image-url("icons/Pen.svg");
                        tooltip: Translations.main_open_settings_tooltip;
                        checkable: true;
                        checked <=> root.is_choreography_settings_open;
                        clicked => { root.open_settings(); }
                    }

                    IconButton {
                        icon: @image-url("icons/Svg.svg");
                        tooltip: Translations.main_open_image_tooltip;
                        clicked => { root.open_image(); }
                    }

                    IconButton {
                        icon: @image-url("icons/PlayCircle.svg");
                        tooltip: Translations.main_open_audio_tooltip;
                        clicked => { root.open_audio(); }
                    }
                }
            }

            MainPageDrawerHost {
                y: 0px;
                width: parent.width;
                height: parent.height - root.audio_player_height;
                top_inset: root.top_bar_height;
                inline_left: false;
                left_drawer_width: root.nav_width;
                right_drawer_width: 480px;
                drawer_background: MaterialPalette.surface_variant;
                overlay_color: MaterialPalette.background_modal;
                is_left_open <=> root.is_nav_open;
                is_right_open <=> root.is_choreography_settings_open;
                left_close_on_click_away: true;
                right_close_on_click_away: true;
                scenes: root.scenes;
                scenes_search_text: root.scenes_search_text;
                scenes_show_timestamps: root.scenes_show_timestamps;
                scenes_can_save_choreo: root.scenes_can_save_choreo;
                scenes_can_delete_scene: root.scenes_can_delete_scene;
                scenes_can_navigate_to_settings: root.scenes_can_navigate_to_settings;
                scenes_can_navigate_to_dancer_settings: root.scenes_can_navigate_to_dancer_settings;

                left_close_requested => { root.close_nav(); }
                right_close_requested => { root.close_settings(); }
                scenes_select_scene(index) => { root.scenes_select_scene(index); }
                scenes_update_search_text(value) => { root.scenes_update_search_text(value); }
                scenes_add_scene_before => { root.scenes_add_scene_before(); }
                scenes_add_scene_after => { root.scenes_add_scene_after(); }
                scenes_delete_scene => { root.scenes_delete_scene(); }
                scenes_open_choreo => { root.scenes_open_choreo(); }
                scenes_save_choreo => { root.scenes_save_choreo(); }
                scenes_navigate_to_settings => { root.scenes_navigate_to_settings(); }
                scenes_navigate_to_dancer_settings => { root.scenes_navigate_to_dancer_settings(); }

                floor_canvas := FloorCanvasView {
                    choreography_name: root.floor_choreography_name;
                    scene_name: root.floor_scene_name;
                    floor_front: root.floor_front;
                    floor_back: root.floor_back;
                    floor_left: root.floor_left;
                    floor_right: root.floor_right;
                    show_grid_lines: root.floor_show_grid_lines;
                    floor_color: root.floor_color;
                    subtitle_color: root.floor_subtitle_color;
                    pan_x: root.floor_pan_x;
                    pan_y: root.floor_pan_y;
                    zoom_factor: root.floor_zoom_factor;
                    dancer_size: root.floor_dancer_size;
                    positions: root.floor_positions;
                    curves: root.floor_curves;
                    dashed_curve_segments: root.floor_dashed_curve_segments;
                    selection_segments: root.floor_selection_segments;
                    axis_labels_x: root.floor_axis_labels_x;
                    axis_labels_y: root.floor_axis_labels_y;
                    show_axis_labels: root.floor_show_axis_labels;
                    legend_entries: root.floor_legend_entries;
                    show_legend: root.floor_show_legend;
                    svg_overlay: root.floor_svg_overlay;
                    has_svg_overlay: root.floor_has_svg_overlay;
                    show_placement_overlay: root.floor_show_placement_overlay;
                    remaining_positions: root.floor_remaining_positions;

                    pointer_pressed(x, y, is_primary, is_in_contact) => {
                        root.floor_pointer_pressed(x, y, is_primary, is_in_contact);
                    }
                    pointer_moved(x, y, is_primary, is_in_contact) => {
                        root.floor_pointer_moved(x, y, is_primary, is_in_contact);
                    }
                    pointer_released(x, y, is_primary, is_in_contact) => {
                        root.floor_pointer_released(x, y, is_primary, is_in_contact);
                    }
                    pointer_wheel_changed(delta, x, y) => {
                        root.floor_pointer_wheel_changed(delta, x, y);
                    }
                }
            }

            AudioPlayerView {
                visible: root.is_audio_player_open;
                height: root.audio_player_height;
                y: parent.height - self.height;
                width: parent.width;
                z: 2;
            }
        }
    }
}
